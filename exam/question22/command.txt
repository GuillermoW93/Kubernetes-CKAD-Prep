mkdir -p kustomize-patch-image/base

mkdir -p kustomize-patch-image/overlays/stage

cat <<'EOF_DEP' > kustomize-patch-image/base/deployment.yaml
> apiVersion: apps/v1
> kind: Deployment
> metadata:
>   name: web
> spec:
>   replicas: 2
>   selector:
>     matchLabels:
>       app: web
>   template:
>     metadata:
>       labels:
>         app: web
>     spec:
>       containers:
>       - name: nginx
>         image: nginx:1.21
>         ports:
>         - containerPort: 80
> EOF_DEP

cat <<'EOF_BASE_K' > kustomize-patch-image/base/kustomization.yaml
> resources:
>   - deployment.yaml
> EOF_BASE_K

cat <<'EOF_OVERLAY_K' > kustomize-patch-image/overlays/stage/kustomization.yaml
> resources:
>   - ../../base
> images:
>   - name: nginx
>     newTag: "1.23"
> EOF_OVERLAY_K

kubectl apply -k kustomize-patch-image/overlays/stage
deployment.apps/web created

kubectl get deployment web -o jsonpath='{.spec.template.spec.containers[0].image}'
nginx:1.23
